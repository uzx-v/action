#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
weirdhost-auto - main.py
åŠŸèƒ½ï¼šä½¿ç”¨ Cookie ç™»å½• â†’ ç»­æœŸ â†’ æå–æ–° Cookie â†’ æ›´æ–° GitHub Secrets
ç¯å¢ƒå˜é‡ï¼š
  - REMEMBER_WEB_COOKIE : cookie å€¼ï¼ˆå¿…é¡»ï¼‰
  - REMEMBER_WEB_COOKIE_NAME : cookie åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 'remember_web'ï¼‰
  - SERVER_URL : æœåŠ¡å™¨åœ°å€ï¼ˆå¯é€‰ï¼‰
  - TG_BOT_TOKEN, TG_CHAT_ID : Telegram é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  - REPO_TOKEN : ç”¨äºè‡ªåŠ¨æ›´æ–° GitHub Secretsï¼ˆå¯é€‰ä½†æ¨èï¼‰
  - GITHUB_REPOSITORY : è‡ªåŠ¨ç”± GitHub Actions æä¾›
"""
import os
import asyncio
import aiohttp
import base64
from playwright.async_api import async_playwright, TimeoutError as PlaywrightTimeoutError

try:
    from nacl import encoding, public
    NACL_AVAILABLE = True
except ImportError:
    NACL_AVAILABLE = False
    print("âš ï¸ PyNaCl æœªå®‰è£…ï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–° Secretsã€‚pip install pynacl")

DEFAULT_SERVER_URL = "https://hub.weirdhost.xyz/server/8f686015"
DEFAULT_COOKIE_NAME = "remember_web"


# ------------------ GitHub Secrets æ›´æ–° ------------------
def encrypt_secret(public_key: str, secret_value: str) -> str:
    if not NACL_AVAILABLE:
        raise RuntimeError("PyNaCl æœªå®‰è£…")
    pk = public.PublicKey(public_key.encode("utf-8"), encoding.Base64Encoder())
    sealed_box = public.SealedBox(pk)
    encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
    return base64.b64encode(encrypted).decode("utf-8")


async def update_github_secret(secret_name: str, secret_value: str) -> bool:
    repo_token = os.environ.get("REPO_TOKEN", "").strip()
    repository = os.environ.get("GITHUB_REPOSITORY", "").strip()

    if not repo_token or not repository or not NACL_AVAILABLE:
        print(f"âš ï¸ è·³è¿‡æ›´æ–° {secret_name}ï¼ˆç¼ºå°‘ REPO_TOKEN/GITHUB_REPOSITORY æˆ– PyNaClï¼‰")
        return False

    headers = {
        "Accept": "application/vnd.github+json",
        "Authorization": f"Bearer {repo_token}",
        "X-GitHub-Api-Version": "2022-11-28",
    }

    async with aiohttp.ClientSession() as session:
        try:
            # è·å– public key
            pk_url = f"https://api.github.com/repos/{repository}/actions/secrets/public-key"
            async with session.get(pk_url, headers=headers) as resp:
                if resp.status != 200:
                    print(f"âŒ è·å– public key å¤±è´¥: {resp.status}")
                    return False
                pk_data = await resp.json()

            # åŠ å¯†å¹¶æ›´æ–°
            encrypted_value = encrypt_secret(pk_data["key"], secret_value)
            secret_url = f"https://api.github.com/repos/{repository}/actions/secrets/{secret_name}"
            payload = {"encrypted_value": encrypted_value, "key_id": pk_data["key_id"]}
            
            async with session.put(secret_url, headers=headers, json=payload) as resp:
                if resp.status in (201, 204):
                    print(f"âœ… å·²æ›´æ–° Secret: {secret_name}")
                    return True
                print(f"âŒ æ›´æ–°å¤±è´¥: {resp.status}")
                return False
        except Exception as e:
            print(f"âŒ æ›´æ–° Secret å‡ºé”™: {e}")
            return False


# ------------------ Telegram é€šçŸ¥ ------------------
async def tg_notify(message: str):
    token = os.environ.get("TG_BOT_TOKEN")
    chat_id = os.environ.get("TG_CHAT_ID")
    if not token or not chat_id:
        return
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    async with aiohttp.ClientSession() as session:
        try:
            await session.post(url, data={"chat_id": chat_id, "text": message})
        except Exception as e:
            print(f"âš ï¸ TG é€šçŸ¥å¤±è´¥: {e}")


async def tg_notify_photo(photo_path: str, caption: str = ""):
    token = os.environ.get("TG_BOT_TOKEN")
    chat_id = os.environ.get("TG_CHAT_ID")
    if not token or not chat_id:
        return
    url = f"https://api.telegram.org/bot{token}/sendPhoto"
    async with aiohttp.ClientSession() as session:
        try:
            with open(photo_path, "rb") as f:
                data = aiohttp.FormData()
                data.add_field("chat_id", chat_id)
                data.add_field("photo", f, filename=os.path.basename(photo_path))
                data.add_field("caption", caption)
                await session.post(url, data=data)
        except Exception as e:
            print(f"âš ï¸ TG å›¾ç‰‡é€šçŸ¥å¤±è´¥: {e}")


# ------------------ Cookie æå– ------------------
async def extract_remember_cookie(context) -> tuple:
    """æå– remember_web* cookieï¼Œè¿”å› (name, value) æˆ– (None, None)"""
    try:
        cookies = await context.cookies()
        for cookie in cookies:
            if cookie["name"].startswith("remember_web"):
                print(f"ğŸª æå–åˆ° Cookie: {cookie['name']} = {cookie['value'][:30]}...")
                return (cookie["name"], cookie["value"])
        return (None, None)
    except Exception as e:
        print(f"âš ï¸ æå– Cookie å¤±è´¥: {e}")
        return (None, None)


# ------------------ ä¸»é€»è¾‘ ------------------
async def add_server_time():
    server_url = os.environ.get("SERVER_URL", DEFAULT_SERVER_URL)
    cookie_value = os.environ.get("REMEMBER_WEB_COOKIE", "").strip()
    cookie_name = os.environ.get("REMEMBER_WEB_COOKIE_NAME", DEFAULT_COOKIE_NAME)

    if not cookie_value:
        msg = "âŒ REMEMBER_WEB_COOKIE æœªè®¾ç½®ï¼Œæ— æ³•ç™»å½•"
        print(msg)
        await tg_notify(msg)
        return

    print("ğŸš€ å¯åŠ¨ Playwright...")

    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        context = await browser.new_context()
        page = await context.new_page()
        page.set_default_timeout(120000)
        page.set_default_navigation_timeout(120000)

        try:
            # ========== 1. æ³¨å…¥ Cookie å¹¶ç™»å½• ==========
            await context.add_cookies([{
                "name": cookie_name,
                "value": cookie_value,
                "domain": "hub.weirdhost.xyz",
                "path": "/",
            }])
            print(f"ğŸ”‘ å·²æ³¨å…¥ Cookie: {cookie_name}")

            await page.goto(server_url, timeout=90000)
            await page.wait_for_load_state("networkidle", timeout=30000)

            # æ£€æŸ¥æ˜¯å¦ç™»å½•æˆåŠŸ
            if "/auth/login" in page.url or "/login" in page.url:
                msg = "âŒ Cookie å·²å¤±æ•ˆï¼Œè¯·æ‰‹åŠ¨æ›´æ–° REMEMBER_WEB_COOKIE"
                print(msg)
                await page.screenshot(path="cookie_expired.png", full_page=True)
                await tg_notify_photo("cookie_expired.png", msg)
                await tg_notify(msg)
                return

            print("âœ… Cookie ç™»å½•æˆåŠŸ")

            # ========== 2. ç‚¹å‡»ç»­æœŸæŒ‰é’® ==========
            add_button = page.locator('button:has-text("ì‹œê°„ì¶”ê°€")')
            if await add_button.count() == 0:
                add_button = page.locator('text=ì‹œê°„ì¶”ê°€')
            if await add_button.count() == 0:
                add_button = page.locator('button:has-text("Add Time")')

            if await add_button.count() == 0:
                await page.screenshot(path="no_button.png", full_page=True)
                await tg_notify_photo("no_button.png", "âŒ æœªæ‰¾åˆ°ç»­æœŸæŒ‰é’®")
                await tg_notify("âŒ æœªæ‰¾åˆ° 'ì‹œê°„ì¶”ê°€' æŒ‰é’®")
                return

            await add_button.nth(0).click()
            print("ğŸ”„ å·²ç‚¹å‡»ç»­æœŸæŒ‰é’®")
            await page.wait_for_timeout(3000)

            # ========== 3. æå–å¹¶æ›´æ–° Cookie ==========
            new_name, new_value = await extract_remember_cookie(context)
            if new_name and new_value:
                # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
                if new_value != cookie_value or new_name != cookie_name:
                    print("ğŸ”„ Cookie å·²æ›´æ–°ï¼Œæ­£åœ¨åŒæ­¥åˆ° GitHub Secrets...")
                    await update_github_secret("REMEMBER_WEB_COOKIE", new_value)
                    if new_name != DEFAULT_COOKIE_NAME:
                        await update_github_secret("REMEMBER_WEB_COOKIE_NAME", new_name)
                    await tg_notify("ğŸ”‘ Cookie å·²è‡ªåŠ¨æ›´æ–°åˆ° GitHub Secrets")
                else:
                    print("â„¹ï¸ Cookie æœªå˜åŒ–ï¼Œæ— éœ€æ›´æ–°")
            else:
                print("âš ï¸ æœªæå–åˆ°æ–° Cookie")

            # ========== 4. æŸ¥è¯¢åˆ°æœŸæ—¶é—´ ==========
            expiry_time = "Unknown"
            try:
                await page.goto(server_url, timeout=90000)
                await page.wait_for_load_state("networkidle", timeout=30000)
                expiry_time = await page.evaluate("""
                    () => {
                        const text = document.body.innerText;
                        const match = text.match(/ìœ í†µê¸°í•œ\\s*(\\d{4}-\\d{2}-\\d{2}(?:\\s+\\d{2}:\\d{2}:\\d{2})?)/);
                        return match ? match[1].trim() : 'Unknown';
                    }
                """)
                print(f"ğŸ“… åˆ°æœŸæ—¶é—´: {expiry_time}")
            except Exception as e:
                print(f"âš ï¸ è·å–åˆ°æœŸæ—¶é—´å¤±è´¥: {e}")

            # ========== 5. å‘é€æˆåŠŸé€šçŸ¥ ==========
            msg = f"âœ… ç»­æœŸæˆåŠŸ\nğŸ“… åˆ°æœŸæ—¶é—´: {expiry_time}\nğŸ”— {server_url}"
            await tg_notify(msg)
            print(msg)

        except Exception as e:
            msg = f"âŒ è„šæœ¬å¼‚å¸¸: {repr(e)}"
            print(msg)
            try:
                await page.screenshot(path="error.png", full_page=True)
                await tg_notify_photo("error.png", msg)
            except:
                pass
            await tg_notify(msg)

        finally:
            await context.close()
            await browser.close()


if __name__ == "__main__":
    asyncio.run(add_server_time())
